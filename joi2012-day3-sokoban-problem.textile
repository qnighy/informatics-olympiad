---
layout: default
title: "Sokoban(倉庫番) - joi2012-day3"
source: "第11回日本情報オリンピック 日本代表選手選考会"
source_url: "http://www.ioi-jp.org/camp/2012/2012-sp-tasks/index.html"
timelimit: "2秒"
memlimit: "512MB"
---

「倉庫番」は，長年人々に愛され続けてきているパズルである．

「倉庫番」は <var>縦M \times 横N</var> マスの正方形に区切られた盤面で行われる．盤面上に箱があり，プレイヤーを操作して箱を目標地点へ動かすことが目的である．この問題では，箱が <var>1</var> 個である場合を考える．盤面の一部のマスは壁であり，プレイヤー・箱・目標地点は壁でない <var>1</var> マスに位置している(プレイヤーや箱は盤面から出ることはない)．以下のいずれかの操作が可能である．
* プレイヤーがいるマスに隣接しているマスのうち壁でなく箱がないマスを <var>1</var> つ選び，プレイヤーをそのマスへ移動させる．
* プレイヤーがいるマスと箱があるマスが隣接していて，さらに，箱のマスに隣接していてプレイヤーと反対側にある壁でないマスが存在するとき，箱をそのマスに動かし，プレイヤーを箱があったマスに移動させる．

ここで，マスとマスが隣接しているとは，それらのマスが <var>1</var> 辺を共有することである．

以下に，「倉庫番」の問題の例を示す．文字 # は壁，文字 @ はプレイヤー，文字 O は箱，文字 X は目標地点，文字 . はその他のマス目を表している．

<pre>
..#@.
.X.O.
##..#
</pre>

この状態からは，以下の操作によって箱を目標地点へ動かすことができる．
* プレイヤーを右に動かす．
* プレイヤーを下に動かす．
* 箱とプレイヤーを左に動かす．
* 箱とプレイヤーを左に動かす．

一方，次の状態からは箱を目標地点へ動かすことはできない．

<pre>
..#..
.X.O.
##.@#
</pre>

あなたは，盤面の壁の位置と目標地点が決まっているとき，プレイヤーと箱を配置して，解ける「倉庫番」の問題が何通りできるか知りたい．ここで，解ける「倉庫番」の問題とは，操作を何回か繰り返して箱を目標地点へ移動させることができるような初期配置を指す．また， *プレイヤーと箱はそれぞれ壁でなく目標地点と異なるマスに配置しなければならず，プレイヤーと箱は異なるマスに配置しなければならない* ．

h2. 課題

盤面の大きさおよび盤面の壁の位置と目標地点が与えられたとき，
解ける「倉庫番」の問題が何通りできるかを求めるプログラムを作成せよ．

h2. 制限

| <var>1 \leqq M \leqq 1\,000</var> | 盤面の縦の長さ |
| <var>1 \leqq N \leqq 1\,000</var> | 盤面の横の長さ |

h2. 入力

標準入力から以下の入力を読み込め．

* <var>1</var> 行目には整数 <var>M, N</var> が空白を区切りとして書かれており，それぞれ盤面の縦と横の長さを表す．
* 続く <var>M</var> 行は盤面の情報を表す．各行は <var>N</var> 文字からなる．各文字は # X . のいずれかであり，文字 # は壁，文字 X は目標地点，文字 . はその他のマス目 (プレイヤーや箱の初期位置の候補でもある) を表している．文字 X はちょうど 1 回現れる．

h2. 出力

標準出力に，解ける「倉庫番」の問題が何通りできるかを表す整数を <var>1</var> 行で出力せよ．

h2. 採点基準

* 採点用データのうち，配点の 20% 分については，<var>M \leqq 50, N \leqq 50</var> を満たす．

h2. 入出力例

|_. 入力例1|_. 出力例1|
|<samp>3 5
==..#..==
==.X...==
==##..#==</samp>|<samp>9</samp>|

解ける「倉庫番」の問題は以下に示す <samp>9</samp> 通りが考えられる．

<pre>
..#@.    ..#.@    ..#..    ..#..    ..#..    ..#..    ..#@.    ..#.@    ..#..
.XO..    .XO..    .XO@.    .XO.@    .XO..    .XO..    .X.O.    .X.O.    .X.O@
##..#    ##..#    ##..#    ##..#    ##@.#    ##.@#    ##..#    ##..#    ##..#
</pre>

|_. 入力例2|_. 出力例2|
|<samp>2 3
==.X.==
==...==</samp>|<samp>0</samp>|

この例では，解ける「倉庫番」の問題を作ることができない．

|_. 入力例3|_. 出力例3|
|<samp>4 7
==.#.#.##==
==##.#..#==
==....X..==
==##.#...==</samp>|<samp>24</samp>|
